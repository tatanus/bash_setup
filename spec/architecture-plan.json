{
  "schema_version": "1.0.0",
  "plan_status": "LOCKED",
  "locked_against_tool_spec_sha256": "c33e6d1448f61caaf47bbbd4857806bd421391701a0af5cc5e8282fc9c1c4813",
  "generated_at_utc": "2026-01-09T00:00:00Z",
  "tool_name": "bash_setup",
  "tool_version": "1.0.0",
  "language_mode": "bash",
  "architecture_plan": {
    "overview": "Pure Bash dotfiles installer with monolithic entrypoint design. Single install.sh script handles all operations (install/update/uninstall) with external common_core dependency for file operations and logging. No internal lib/ modules - all logic contained in entrypoint. Checksum-based change detection for updates. Test coverage via bats framework.",
    "design_philosophy": "Monolithic single-file design prioritizing simplicity and minimal dependencies. All business logic in install.sh entrypoint. External common_core provides reusable utilities (file::copy, file::restore_old_backup, logging). No internal Bash libraries to maintain - installer is self-contained except for common_core integration.",
    "components": {
      "entrypoints": [
        {
          "path": "install.sh",
          "type": "bash_script",
          "executable": true,
          "responsibilities": [
            "Parse CLI arguments (install|update|uninstall, --help, --version, --quiet, --force, --skip-tools)",
            "Execute preflight checks (Bash version, HOME variable, common_core availability)",
            "Load external common_core library",
            "Manage dotfiles arrays (COMMON_DOT_FILES, BASH_DOT_FILES)",
            "Create required directories (DATA/LOGS, .config/bash, .config/bash/log)",
            "Install dotfiles with backups via common_core file::copy",
            "Update only changed dotfiles using SHA-256 checksum comparison",
            "Uninstall and restore from backups via common_core file::restore_old_backup",
            "Check for recommended tools (eza, fzf, ncat, freeze, bat, duf, btop)",
            "Provide structured logging with timestamps",
            "Return appropriate exit codes (0=success, 1=runtime error, 2=validation error)"
          ],
          "functions": [
            "usage() - Display help message",
            "preflight_checks() - Verify system requirements",
            "load_common_core() - Source external common_core util.sh",
            "setup_directories() - Create required directory structure",
            "check_recommended_tools() - Verify optional tool availability",
            "files_differ() - SHA-256 checksum comparison for update detection",
            "cmd_install() - Install dotfiles with optional tool checks",
            "cmd_update() - Update only changed files",
            "cmd_uninstall() - Restore backups",
            "main() - Entry point and argument parser",
            "_log_fail(), _log_pass(), _log_info(), _log_warn() - Minimal logging before common_core load"
          ],
          "external_dependencies": [
            "common_core library at ~/.config/bash/lib/common_core/util.sh (REQUIRED)",
            "common_core functions: file::copy, file::restore_old_backup, cmd::exists, info, warn, fail, pass, debug"
          ],
          "strict_mode": "set -uo pipefail, IFS=$'\\n\\t'",
          "complexity": "monolithic (518 lines, all logic in single file)"
        }
      ],
      "bash_modules": [],
      "python_modules": [],
      "data_files": [
        {
          "path": "dotfiles/",
          "type": "directory",
          "contents": "Source dotfiles to be installed",
          "files": [
            "bashrc", "profile", "bash_profile", "tmux.conf", "screenrc_v4", "screenrc_v5",
            "inputrc", "vimrc", "wgetrc", "curlrc", "bash.path.sh", "bash.env.sh", "path.env.sh",
            "bash.funcs.sh", "bash.aliases.sh", "screen.aliases.sh", "tmux.aliases.sh",
            "bash.prompt.sh", "bash.prompt_funcs.sh", "bash-preexec.sh", "combined.history.sh",
            "ssh.aliases.sh", "bash.visuals.sh"
          ]
        },
        {
          "path": "VERSION",
          "type": "file",
          "format": "plain_text_semver"
        }
      ],
      "tools": [
        {
          "path": "tools/check_bash_style.sh",
          "type": "bash_script",
          "executable": true
        },
        {
          "path": "tools/compile.sh",
          "type": "bash_script",
          "executable": true
        }
      ],
      "test_suite": {
        "framework": "bats",
        "test_files": [
          {"path": "tests/00_bootstrap.bats"},
          {"path": "tests/10_install_help.bats"},
          {"path": "tests/20_preflight.bats"}
        ],
        "test_helpers": [
          {"path": "tests/load.bash"},
          {"path": "tests/helpers/common.bash"}
        ]
      },
      "build_system": {
        "path": "Makefile"
      }
    },
    "language_mode_enforcement": {
      "mode": "bash",
      "required_files": [
        "install.sh", "dotfiles/*", "tests/*.bats", "tests/load.bash",
        "tests/helpers/common.bash", "tools/check_bash_style.sh", "tools/compile.sh",
        "VERSION", "Makefile", ".shellcheckrc"
      ],
      "forbidden_file_patterns": [
        "src/**/*.py", "**/*.pyc", "**/__pycache__/",
        "requirements.txt", "pyproject.toml", "setup.py", "venv/"
      ],
      "validation_rules": [
        "All *.sh files must have Bash shebang (#!/usr/bin/env bash)",
        "All *.sh files must use strict mode: set -uo pipefail, IFS=$'\\n\\t'",
        "install.sh must be executable (chmod +x)",
        "No Python imports or execution in any Bash script",
        "External common_core dependency must be documented but not bundled"
      ]
    },
    "interfaces": {
      "bash_to_python": {
        "enabled": false,
        "reason": "Python disabled in ToolSpec (language_mode=bash, python.enabled=false)"
      },
      "external_libraries": [
        {
          "name": "common_core",
          "type": "bash_library",
          "location": "~/.config/bash/lib/common_core/",
          "required": true,
          "functions_used": [
            "file::copy(src, dest)", "file::restore_old_backup(target)",
            "cmd::exists(command)", "info(message)", "warn(message)",
            "fail(message)", "pass(message)", "debug(message)"
          ]
        }
      ],
      "cli_interface": {
        "commands": ["install", "update", "uninstall"],
        "options": ["--help, -h", "--version, -v", "--quiet, -q", "--force, -f", "--skip-tools"],
        "exit_codes": {"0": "Success", "1": "Runtime error", "2": "Validation error"}
      }
    },
    "dependency_graph": {
      "description": "Dependency relationships between components. Monolithic architecture means minimal internal dependencies.",
      "nodes": [
        {"id": "install.sh", "type": "entrypoint", "file_path": "install.sh"},
        {"id": "common_core", "type": "external_library", "file_path": "~/.config/bash/lib/common_core/util.sh"},
        {"id": "dotfiles", "type": "data_directory", "file_path": "dotfiles/"},
        {"id": "VERSION", "type": "data_file", "file_path": "VERSION"},
        {"id": "tests", "type": "test_suite", "file_path": "tests/"},
        {"id": "check_bash_style.sh", "type": "tool", "file_path": "tools/check_bash_style.sh"},
        {"id": "compile.sh", "type": "tool", "file_path": "tools/compile.sh"},
        {"id": "Makefile", "type": "build_system", "file_path": "Makefile"},
        {"id": ".shellcheckrc", "type": "config", "file_path": ".shellcheckrc"}
      ],
      "edges": [
        {"from": "install.sh", "to": "common_core", "type": "bash_source"},
        {"from": "install.sh", "to": "dotfiles", "type": "data_file"},
        {"from": "install.sh", "to": "VERSION", "type": "data_file"},
        {"from": "tests", "to": "install.sh", "type": "test_target"},
        {"from": "tests", "to": "dotfiles", "type": "test_target"},
        {"from": "tests", "to": "VERSION", "type": "test_target"},
        {"from": "Makefile", "to": "install.sh", "type": "invokes"},
        {"from": "Makefile", "to": "check_bash_style.sh", "type": "invokes"},
        {"from": "Makefile", "to": "tests", "type": "invokes"},
        {"from": "check_bash_style.sh", "to": ".shellcheckrc", "type": "config_file"},
        {"from": "compile.sh", "to": "Makefile", "type": "invokes"},
        {"from": "compile.sh", "to": "VERSION", "type": "data_file"}
      ],
      "acyclic": true
    },
    "requirements_coverage": {
      "requirements": [
        {"id": "REQ-001", "text": "Language mode must be bash with Python disabled", "covered_by": ["install.sh", "language_mode_enforcement"]},
        {"id": "REQ-002", "text": "Single entrypoint install.sh must be executable", "covered_by": ["install.sh", "tests/00_bootstrap.bats"]},
        {"id": "REQ-003", "text": "Support install, update, uninstall commands", "covered_by": ["install.sh main()", "cmd_install()", "cmd_update()", "cmd_uninstall()"]},
        {"id": "REQ-004", "text": "Support CLI options: --help, --version, --quiet, --force, --skip-tools", "covered_by": ["install.sh main()", "usage()"]},
        {"id": "REQ-005", "text": "Bash 4+ required", "covered_by": ["install.sh preflight_checks()"]},
        {"id": "REQ-006", "text": "Strict mode: set -uo pipefail, IFS hardening", "covered_by": ["install.sh lines 16-17"]},
        {"id": "REQ-007", "text": "HOME environment variable must be set", "covered_by": ["install.sh preflight_checks()"]},
        {"id": "REQ-008", "text": "common_core library must be present", "covered_by": ["install.sh preflight_checks()", "load_common_core()"]},
        {"id": "REQ-009", "text": "Use common_core functions", "covered_by": ["install.sh cmd_install()", "cmd_update()", "cmd_uninstall()"]},
        {"id": "REQ-010", "text": "Read dotfiles from dotfiles/ directory", "covered_by": ["install.sh COMMON_DOT_FILES", "BASH_DOT_FILES"]},
        {"id": "REQ-011", "text": "Install dotfiles to HOME directory", "covered_by": ["install.sh cmd_install()"]},
        {"id": "REQ-012", "text": "Install bash config files to HOME/.config/bash/", "covered_by": ["install.sh cmd_install()", "BASH_DIR"]},
        {"id": "REQ-013", "text": "Create required directories", "covered_by": ["install.sh setup_directories()"]},
        {"id": "REQ-014", "text": "Create backups for replaced files", "covered_by": ["common_core file::copy"]},
        {"id": "REQ-015", "text": "Update uses SHA-256 checksum comparison", "covered_by": ["install.sh files_differ()", "cmd_update()"]},
        {"id": "REQ-016", "text": "Checksum tools: sha256sum or shasum", "covered_by": ["install.sh files_differ()"]},
        {"id": "REQ-017", "text": "Uninstall restores from backups", "covered_by": ["install.sh cmd_uninstall()"]},
        {"id": "REQ-018", "text": "Check recommended tools", "covered_by": ["install.sh check_recommended_tools()"]},
        {"id": "REQ-019", "text": "Structured logging with levels", "covered_by": ["install.sh _log_*() functions", "common_core logging"]},
        {"id": "REQ-020", "text": "Exit code 0 for success", "covered_by": ["install.sh main()"]},
        {"id": "REQ-021", "text": "Exit code 2 for validation errors", "covered_by": ["install.sh main()", "install.sh preflight_checks()"]},
        {"id": "REQ-022", "text": "Exit code 1 for runtime errors", "covered_by": ["install.sh main()"]},
        {"id": "REQ-023", "text": "Handle missing source files gracefully", "covered_by": ["install.sh cmd_install()", "cmd_update()"]},
        {"id": "REQ-024", "text": "Handle missing backups during uninstall", "covered_by": ["install.sh cmd_uninstall()"]},
        {"id": "REQ-025", "text": "bats test framework", "covered_by": ["tests/*.bats"]},
        {"id": "REQ-026", "text": "Test repository structure", "covered_by": ["tests/00_bootstrap.bats"]},
        {"id": "REQ-027", "text": "Test --help and --version", "covered_by": ["tests/10_install_help.bats"]},
        {"id": "REQ-028", "text": "Test unknown option rejection", "covered_by": ["tests/10_install_help.bats"]},
        {"id": "REQ-029", "text": "Test preflight detects missing common_core", "covered_by": ["tests/20_preflight.bats"]},
        {"id": "REQ-030", "text": "Test preflight verifies Bash 4+", "covered_by": ["tests/20_preflight.bats"]},
        {"id": "REQ-031", "text": "Test dotfiles directory contains expected files", "covered_by": ["tests/20_preflight.bats"]},
        {"id": "REQ-032", "text": "Makefile with required targets", "covered_by": ["Makefile"]},
        {"id": "REQ-033", "text": "README sections", "covered_by": ["README.md"]},
        {"id": "REQ-034", "text": "VERSION file with semver", "covered_by": ["VERSION"]},
        {"id": "REQ-035", "text": "Platform support: darwin and linux", "covered_by": ["install.sh portable implementation"]},
        {"id": "REQ-036", "text": "jq tool required for pipeline tooling", "covered_by": ["spec/tool-spec.json constraints.tools", "pipeline infrastructure"]},
        {"id": "REQ-037", "text": "Document security threat model", "covered_by": ["spec/tool-spec.json security.threat_model", "README.md Security section"]},
        {"id": "REQ-038", "text": "Document and implement safety controls for unsafe operations", "covered_by": ["spec/tool-spec.json security.unsafe_operations", "install.sh cmd_install()", "install.sh cmd_update()", "install.sh cmd_uninstall()"]},
        {"id": "REQ-039", "text": "Verify dotfiles/ source directory exists before operations", "covered_by": ["install.sh preflight_checks()"]},
        {"id": "REQ-040", "text": "Check file existence before attempting copy or restore", "covered_by": ["install.sh cmd_install()", "install.sh cmd_update()", "install.sh cmd_uninstall()"]},
        {"id": "REQ-041", "text": "Use mkdir -p for all directory creation for idempotency", "covered_by": ["install.sh setup_directories()"]},
        {"id": "REQ-042", "text": "Ensure strict mode in all scripts", "covered_by": ["install.sh lines 16-17", "tools/check_bash_style.sh", "tools/compile.sh"]}
      ],
      "uncovered": []
    },
    "files_to_modify": [
      {"path": "install.sh", "reason": "Fix exit code for preflight validation failures (should be 2, not 1)"}
    ],
    "files_to_create": [],
    "files_to_delete": [],
    "risks": [
      {"risk": "Exit code mismatch for validation errors", "severity": "medium"},
      {"risk": "Insufficient test coverage for core operations", "severity": "medium"},
      {"risk": "Dependency on external common_core without version contract", "severity": "low"},
      {"risk": "jq tool listed but unused", "severity": "low"}
    ]
  },
  "audit_metadata": {
    "architecture_gate_run_id": "architecture_gate_2026-01-09_00-00-00",
    "spec_ratification_verified": true,
    "spec_sha256_match": true
  }
}
