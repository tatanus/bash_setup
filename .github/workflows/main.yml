name: Bash Project CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  style:
    name: Enforce Bash Style Guide
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo snap install shellcheck --classic
          sudo apt-get update
          sudo apt-get install -y shfmt

      - name: Run Style Guide Checks
        run: |
          chmod +x ./check_bash_style.sh
          ./check_bash_style.sh
 
  validate_permissions:
    name: Validate File Permissions and Shebangs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Ensure Executable Permissions
        run: |
          find . -name "*.sh" -exec chmod +x {} \;

      - name: Validate Shebangs
        shell: bash
        run: |
          set -euo pipefail
          missing_shebangs=$(
            find . -name "*.sh" \
              ! -path "./.git/*" \
              ! -path "./lib/common_core/*" \
              ! -path "./dotfiles/bash-preexec.sh" \
              -exec sh -c 'head -n 1 "$1" | grep -q "^#!" || echo "$1"' _ {} \;
          )
          if [[ -n "${missing_shebangs}" ]]; then
            echo "The following files are missing a shebang:"
            echo "${missing_shebangs}"
            exit 1
          fi

  tests:
    needs: [style]
    name: Run BATS Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git
          sudo ./bats-core/install.sh /usr/local

      - name: Run tests (BATS)
        run: |
          if compgen -G "tests/**/*.bats" > /dev/null || compgen -G "tests/*.bats" > /dev/null; then
            bats -r tests
          else
            echo "No BATS tests found."
          fi
